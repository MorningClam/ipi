<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Culturo</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100 overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col">
            <!-- Logo -->
            <div class="h-16 flex items-center justify-center px-4 border-b border-gray-200 flex-shrink-0">
                <a href="dashboard.html" class="font-bold text-2xl text-gray-900 flex items-center gap-2">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-indigo-600"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span>Culturo</span>
                </a>
            </div>
            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200">
                <form action="search-results.html">
                    <div class="relative">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"></i>
                        <input type="search" placeholder="Search..." class="w-full pl-10 pr-4 py-2 text-sm rounded-lg bg-gray-100 border-transparent focus:bg-white focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </form>
            </div>
            <!-- Nav Links -->
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Find</p>
                <a href="find-agents.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="briefcase" class="w-5 h-5"></i>
                    <span>Find Agents</span>
                </a>
                <a href="find-universities.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="school" class="w-5 h-5"></i>
                    <span>Find Universities</span>
                </a>
                <a href="find-events.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="calendar-search" class="w-5 h-5"></i>
                    <span>Find Events</span>
                </a>
                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Workspace</p>
                <a href="organization-partnerships.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="handshake" class="w-5 h-5"></i>
                    <span>Partnerships</span>
                </a>
                <a href="targets.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="target" class="w-5 h-5"></i>
                    <span>Targets</span>
                </a>
                <a href="groups.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Groups</span>
                </a>
                <a href="messages.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    <span>Messages</span>
                </a>
                <a href="notifications.html" class="flex items-center gap-3 px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span>Notifications</span>
                </a>
            </nav>
            <!-- User Profile Link & Settings -->
            <div class="px-4 py-6 border-t border-gray-200">
                <a href="profile.html" class="flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm" id="sidebar-avatar">GH</div>
                    <div>
                        <p class="font-semibold text-gray-800 group-hover:text-indigo-600" id="sidebar-user-name">George Hogan</p>
                        <p class="text-sm text-gray-500" id="sidebar-org-name">Global University</p>
                    </div>
                </a>
                <a href="account-settings.html" class="flex items-center gap-3 px-4 py-2.5 mt-4 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Settings</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-900 mb-8">Edit Profile</h1>

                <div class="bg-white rounded-2xl shadow-sm">
                    <form id="profile-form">
                        <div class="p-8 space-y-8">
                            <!-- Profile Picture Section -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Profile Picture</h2>
                                <div class="flex items-center gap-6">
                                    <div class="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-2xl" id="profile-picture">GH</div>
                                    <button type="button" class="bg-gray-200 text-gray-800 font-semibold px-5 py-2.5 rounded-lg hover:bg-gray-300 transition-colors">
                                        Upload New Picture
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Personal Information Section -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Personal Information</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input type="text" id="fullname" name="fullname" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title / Position</label>
                                        <input type="text" id="title" name="title" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="email" name="email" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input type="tel" id="phone" name="phone" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                        <input type="text" id="location" name="location" placeholder="City, Country" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="organization" class="block text-sm font-medium text-gray-700 mb-1">Organization</label>
                                        <input type="text" id="organization" name="organization" readonly class="w-full rounded-lg border-gray-300 shadow-sm bg-gray-50 px-4 py-3">
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Information Section -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Professional Information</h2>
                                <div class="space-y-6">
                                    <div>
                                        <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">About / Bio</label>
                                        <textarea id="bio" name="bio" rows="4" placeholder="Tell others about your professional background and expertise..." class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3"></textarea>
                                    </div>
                                    <div>
                                        <label for="expertise" class="block text-sm font-medium text-gray-700 mb-1">Areas of Expertise</label>
                                        <input type="text" id="expertise" name="expertise" placeholder="e.g., Student Exchange, Joint Programs, Research Partnerships" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                    <div>
                                        <label for="linkedin" class="block text-sm font-medium text-gray-700 mb-1">LinkedIn Profile</label>
                                        <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/yourprofile" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-3">
                                    </div>
                                </div>
                            </div>

                            <!-- Experience Section -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Experience</h2>
                                <div id="experience-entries" class="space-y-6">
                                    <!-- Experience entries will be dynamically added here -->
                                </div>
                                <button type="button" id="add-experience-btn" class="mt-4 flex items-center gap-2 text-indigo-600 hover:text-indigo-700 font-medium">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Add Experience</span>
                                </button>
                            </div>

                            <!-- Partnership Preferences Section -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Partnership Preferences</h2>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-3">Looking For</label>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="looking_for" value="student_exchange" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Student Exchange</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="looking_for" value="joint_programs" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Joint Programs</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="looking_for" value="research" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Research</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="looking_for" value="faculty_exchange" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Faculty Exchange</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-3">Current Goals</label>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="goals" value="expand_network" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Expand Network</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="goals" value="online_programs" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Launch Online Programs</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" name="goals" value="sustainability" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                                                <span class="text-sm">Sustainability Focus</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="px-8 py-6 bg-gray-50 border-t border-gray-200 flex justify-between rounded-b-2xl">
                            <a href="profile.html" class="bg-gray-200 text-gray-800 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors">Cancel</a>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Load user data
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('authToken'); // Fixed: Use authToken not access_token
            
            if (!token) {
                console.log('No token found, showing default form');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.log('Failed to fetch user data, showing default form');
                    return;
                }

                const user = await response.json();
                
                // Update profile information with real data
                const initials = user.full_name ? 
                    user.full_name.split(' ').map(n => n[0]).join('').toUpperCase() : 'GH';
                
                // Update form fields - Fixed: Map to correct backend fields
                document.getElementById('fullname').value = user.full_name || '';
                document.getElementById('title').value = user.user_type || ''; // Maps to user_type in backend
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('location').value = user.location || '';
                document.getElementById('bio').value = user.about || ''; // Maps to about field
                document.getElementById('linkedin').value = user.linkedin || '';
                
                // Load experience data if available
                if (user.experience && user.experience.length > 0) {
                    loadExperienceEntries(user.experience);
                } else {
                    // Add one empty experience entry by default
                    addExperienceEntry();
                }
                
                // Update sidebar and profile avatars
                document.getElementById('sidebar-user-name').textContent = user.full_name || 'George Hogan';
                document.getElementById('sidebar-avatar').textContent = initials;
                document.getElementById('profile-picture').textContent = initials;
                
                // Load organization data if user has one
                if (user.organization_id) {
                    const orgResponse = await fetch(`http://127.0.0.1:8000/api/organizations/${user.organization_id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (orgResponse.ok) {
                        const org = await orgResponse.json();
                        document.getElementById('organization').value = org.name;
                        document.getElementById('sidebar-org-name').textContent = org.name;
                    }
                } else {
                    document.getElementById('organization').value = 'No Organization';
                    document.getElementById('sidebar-org-name').textContent = 'Independent';
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                console.log('Showing default form due to error');
            }
        });

        // Handle form submission
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('authToken'); // Fixed: Use authToken not access_token
            if (!token) {
                alert('Please log in to update your profile');
                return;
            }

            const formData = new FormData(this);
            // Fixed: Map form fields to correct backend field names
            const profileData = {
                full_name: formData.get('fullname'),
                user_type: formData.get('title'), // Maps title input to user_type backend field
                email: formData.get('email'),
                phone: formData.get('phone'),
                location: formData.get('location'),
                about: formData.get('bio'), // Maps bio input to about backend field
                linkedin: formData.get('linkedin'),
                experience: collectExperienceData() // Collect experience entries
            };

            try {
                const response = await fetch('http://127.0.0.1:8000/api/users/me', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    alert('Profile updated successfully!');
                    window.location.href = 'profile.html';
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });

        // Experience management functions
        let experienceCounter = 0;

        function addExperienceEntry(experience = null) {
            experienceCounter++;
            const container = document.getElementById('experience-entries');
            
            const entry = document.createElement('div');
            entry.className = 'border border-gray-200 rounded-lg p-6';
            entry.dataset.experienceId = experienceCounter;
            
            entry.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Experience ${experienceCounter}</h3>
                    <button type="button" class="text-red-600 hover:text-red-700" onclick="removeExperienceEntry(${experienceCounter})">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Job Title *</label>
                        <input type="text" name="exp_${experienceCounter}_title" required 
                               value="${experience?.title || ''}"
                               placeholder="e.g., Dean of International Relations"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company/Organization *</label>
                        <input type="text" name="exp_${experienceCounter}_company" required
                               value="${experience?.company || ''}"
                               placeholder="e.g., Global University"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                        <input type="text" name="exp_${experienceCounter}_start_date" required
                               value="${experience?.start_date || ''}"
                               placeholder="e.g., 2018 or Jan 2018"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="text" name="exp_${experienceCounter}_end_date"
                               value="${experience?.end_date || ''}"
                               placeholder="e.g., Present or Dec 2023"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea name="exp_${experienceCounter}_description" rows="3"
                                  placeholder="Describe your key responsibilities and achievements..."
                                  class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">${experience?.description || ''}</textarea>
                    </div>
                </div>
            `;
            
            container.appendChild(entry);
            
            // Re-initialize Lucide icons for the new elements
            lucide.createIcons();
        }

        function removeExperienceEntry(id) {
            const entry = document.querySelector(`[data-experience-id="${id}"]`);
            if (entry) {
                entry.remove();
            }
        }

        function loadExperienceEntries(experiences) {
            experiences.forEach(exp => {
                addExperienceEntry(exp);
            });
        }

        function collectExperienceData() {
            const experiences = [];
            const entries = document.querySelectorAll('#experience-entries > div');
            
            entries.forEach(entry => {
                const id = entry.dataset.experienceId;
                const title = entry.querySelector(`[name="exp_${id}_title"]`).value.trim();
                const company = entry.querySelector(`[name="exp_${id}_company"]`).value.trim();
                const startDate = entry.querySelector(`[name="exp_${id}_start_date"]`).value.trim();
                const endDate = entry.querySelector(`[name="exp_${id}_end_date"]`).value.trim();
                const description = entry.querySelector(`[name="exp_${id}_description"]`).value.trim();
                
                if (title && company && startDate) {
                    experiences.push({
                        title,
                        company,
                        start_date: startDate,
                        end_date: endDate || 'Present',
                        description
                    });
                }
            });
            
            return experiences;
        }

        // Add event listener for adding experience
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('add-experience-btn').addEventListener('click', function() {
                addExperienceEntry();
            });
        });
    </script>

    <script>
        lucide.createIcons();
    </script>
</body>
</html>